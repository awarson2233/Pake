name: Build Gemini (Windows ARM64)

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Web app URL"
        required: true
        default: "https://gemini.google.com/app"
      app_name:
        description: "App name"
        required: true
        default: "Gemini"

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Rust (stable) with WinARM64 target
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-pc-windows-msvc

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            C:\Users\runneradmin\.cargo\registry
            C:\Users\runneradmin\.cargo\git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install frontend deps
        run: pnpm install --frozen-lockfile

      # 如果你的项目是 Tauri/基于 Pake 的打包器，tauri-action 会自动执行构建和打包
      - name: Build (Windows ARM64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }} # 如果需要签名，配置即可
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }} # 如果需要签名，配置即可
        with:
          target: aarch64-pc-windows-msvc
          args: >
            -- -- --url "${{ github.event.inputs.url }}"
            --name "${{ github.event.inputs.app_name }}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-arm64-bundles
          path: |
            src-tauri/target/aarch64-pc-windows-msvc/release/bundle/**
