name: Build Gemini for Windows ARM64

on:
  workflow_dispatch: # 允许手动点击按钮触发

jobs:
  build-arm64:
    runs-on: windows-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Rust Stable
        uses: dtolnay/rust-toolchain@stable
        with:
          # 关键：添加 aarch64 (ARM64) 目标架构
          targets: aarch64-pc-windows-msvc

      - name: Install Dependencies
        run: pnpm install

      - name: Configure for Gemini
        # 这里使用 Pake 的脚本来修改配置，使其变成 Gemini
        # 我们只修改配置，不立即构建，因为我们要手动指定 ARM64 目标
        run: |
          # 这一步是为了生成 tauri.conf.json，使用 Pake 自带的逻辑
          # 注意：这里我们通过修改 dist/cli.js 或者直接修改 json 来实现
          # 为了简单，我们直接用 sed 替换默认配置（Pake 默认通常是 Twitter 或其他）
          
          # 1. 修改 URL
          (Get-Content src-tauri/tauri.conf.json).replace('"url": "https://mobile.twitter.com"', '"url": "https://gemini.google.com"') | Set-Content src-tauri/tauri.conf.json
          
          # 2. 修改应用名称
          (Get-Content src-tauri/tauri.conf.json).replace('"productName": "Pake"', '"productName": "Gemini"') | Set-Content src-tauri/tauri.conf.json
          
          # 3. 修改窗口标题
          (Get-Content src-tauri/tauri.conf.json).replace('"title": "Pake"', '"title": "Gemini"') | Set-Content src-tauri/tauri.conf.json

          # 打印一下确认修改成功
          Get-Content src-tauri/tauri.conf.json | Select-String "gemini"

      - name: Build for ARM64
        # 核心步骤：指定 target 为 aarch64-pc-windows-msvc
        run: pnpm tauri build --target aarch64-pc-windows-msvc

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Gemini-Windows-ARM64
          path: src-tauri/target/aarch64-pc-windows-msvc/release/bundle/msi/*.msi
          if-no-files-found: error
