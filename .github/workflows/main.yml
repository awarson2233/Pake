name: Build Gemini (Windows ARM64)

env:
  NODE_VERSION: "22"
  PNPM_VERSION: "10.26.2"

on:
  workflow_dispatch:
    inputs:
      name:
        description: "App Name"
        required: true
        default: "gemini"
      title:
        description: "App Title"
        required: true
        default: "Gemini"
      name_zh:
        description: "App Name in Chinese"
        required: true
        default: "Gemini"
      url:
        description: "App URL"
        required: true
        default: "https://gemini.google.com/app"
      icon:
        description: "App Icon"
        required: false
  workflow_call:
    inputs:
      name:
        description: "App Name"
        type: string
        required: true
        default: "gemini"
      title:
        description: "App Title"
        required: true
        type: string
        default: "Gemini"
      name_zh:
        description: "App Name in Chinese"
        required: true
        type: string
        default: "Gemini"
      url:
        description: "App URL"
        required: true
        type: string
        default: "https://gemini.google.com/app"
      icon:
        description: "App Icon"
        type: string
        required: false

jobs:
  build:
    name: ${{ inputs.title }} (windows-arm64)
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable-aarch64-pc-windows-msvc

      - name: Setup Node.js Environment
        uses: ./.github/actions/setup-env
        with:
          mode: build

      - name: Download CLI Artifact
        uses: actions/download-artifact@v4
        with:
          name: pake-cli-dist
          path: dist

      - name: Build for Windows ARM64
        timeout-minutes: 25
        shell: pwsh
        run: |
          $args = @("${{ inputs.url }}", "--name", "${{ inputs.name }}")

          # Auto-detect local icon or use provided icon
          if ("${{ inputs.icon }}" -ne "") {
            $args += @("--icon", "${{ inputs.icon }}")
          } elseif (Test-Path "src-tauri\png\${{ inputs.name }}_256.ico") {
            $args += @("--icon", "src-tauri\png\${{ inputs.name }}_256.ico")
          }

          # ARM64 target
          $args += @("--targets", "arm64")

          node dist/cli.js $args

          New-Item -Path "output\windows" -ItemType Directory -Force

          # The CLI copies the MSI to project root and removes it from bundle directory
          $projectRootMsi = "${{ inputs.name }}.msi"

          if (Test-Path $projectRootMsi) {
            Move-Item -Path $projectRootMsi -Destination "output\windows\${{inputs.title}}_arm64.msi"
          } else {
            # Check architecture-specific path (ARM64 builds)
            $msiFiles = Get-ChildItem -Path "src-tauri\target\aarch64-pc-windows-msvc\release\bundle\msi\*.msi" -ErrorAction SilentlyContinue

            # Fallback to generic path
            if (-not $msiFiles) {
              $msiFiles = Get-ChildItem -Path "src-tauri\target\release\bundle\msi\*.msi" -ErrorAction SilentlyContinue
            }

            if ($msiFiles) {
              Move-Item -Path $msiFiles[0].FullName -Destination "output\windows\${{inputs.title}}_arm64.msi"
            } else {
              Write-Error "No MSI files found in expected locations"
              Write-Host "Searched paths:"
              Write-Host "  - $projectRootMsi (project root)"
              Write-Host "  - src-tauri\target\aarch64-pc-windows-msvc\release\bundle\msi\"
              Write-Host "  - src-tauri\target\release\bundle\msi\"
              Write-Host "`nAll MSI files in target directory:"
              Get-ChildItem -Path "src-tauri\target\" -Recurse -Name "*.msi" | Write-Host
              exit 1
            }
          }

          git checkout -- src-tauri/Cargo.lock

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.title }}-windows-arm64
          path: output/*/*.*
          retention-days: 3

      - name: Upload to release (Windows ARM64)
        uses: ncipollo/release-action@v1 # cspell:disable-line
        if: startsWith(github.ref, 'refs/tags/')
        with:
          allowUpdates: true
          artifacts: "output/windows/*.msi"
          token: ${{ secrets.GITHUB_TOKEN }}
